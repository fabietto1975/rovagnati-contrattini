<?php

namespace backend\app\dao;

use backend\common\dao\DAOAbstract;
use backend\common\dao\DAOInterface;

class UserDAO extends DAOAbstract implements DAOInterface {

    public function __construct() {
        parent::__construct();
    }

    public function create($item) {
        //NOP
    }

    public function delete($id) {
        //NOP
    }

    public function readByID($id) {
        $stmt = $this->getPdo()->prepare(
                "SELECT * "
                . "FROM anagrafica_utente u "
                . "WHERE u.id=:id ");
        $stmt->bindValue('id', $id);
        $stmt->execute();
        $res = $stmt->fetch();
        return $res;
    }

    public function read() {
        
    }

    public function update($item) {
        //NOP
    }

    public function login($username, $password, $application) {
        $stmt = $this->getPdo()->prepare(""
                . "SELECT * "
                . "FROM anagrafica_utente u "
                . "WHERE u.USERNAME = :username and md5(:password) = u.password "
        );
        $stmt->bindValue('username', $username);
        $stmt->bindValue('password', $password);
        $stmt->execute();
        $res = $stmt->fetch();

        if ($res != null) {
            $cod_dipendente = $res['cod_dipendente'];
            $ruolo = $res['ruolo'];
            $colonna = '';
            if ($ruolo == 'AGENTE') {
                $colonna = 'agente';
            } else if ($ruolo == 'ISPETTORE') {
                $colonna = 'cod_ispettore';
            } else if ($ruolo == 'CAPOAREA') {
                $colonna = 'cod_capo_area';
            }
            $stmt = $this->getPdo()->prepare(""
                    . "SELECT 
                        localita,
                        CONCAT(localita,
                                ' (',
                                provincia_nazione,
                                ')'
                                ) AS descrizione_localita
                    FROM
                        anagrafica_cliente
                    WHERE
                        " . $colonna . " = :cod_dipendente
                    GROUP BY localita ,  provincia_nazione "
            );
            $stmt->bindValue('cod_dipendente', $cod_dipendente);
            $stmt->execute();
            $comuni = $stmt->fetchAll();
            $res['comuni'] = $comuni;
            return array(
                'status' => 'OK',
                'res' => $res
            );
        } else {
            return array(
                'status' => 'KO',
                'error' => 'LOGIN_ERROR'
            );
        }
    }

}
